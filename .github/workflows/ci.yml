name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  guardian:
    name: üíÄ Guardian Protocol
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run Guardian Protocol
        shell: pwsh
        run: |
          pwsh -ExecutionPolicy Bypass -File scripts/ci-guardian.ps1

  runtime-integrity:
    name: üîí Runtime Integrity Guard
    runs-on: ubuntu-latest
    needs: guardian
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Check Runtime Integrity
        run: |
          npx tsx scripts/enforce-runtime-integrity.ts
      - name: Check Runtime Registry
        run: |
          npx tsx scripts/check-runtime-registry.ts

  schema-drift:
    name: üìä Schema Drift Detection
    runs-on: ubuntu-latest
    needs: guardian
    steps:
      - uses: actions/checkout@v4
      - name: Verify Schema Consistency
        run: |
          test -f sdk/schema/drc369.json || exit 1
          test -f sdk/schema/abyssid.json || exit 1
          test -f sdk/schema/fractal1.json || exit 1
          test -f sdk/schema/wallet.json || exit 1
          echo "‚úÖ All schemas present"

  sdk-compatibility:
    name: üîó SDK Compatibility Guard
    runs-on: ubuntu-latest
    needs: guardian
    steps:
      - uses: actions/checkout@v4
      - name: Verify Compatibility Map
        run: |
          test -f sdk/CONTRACT_COMPATIBILITY_MAP.json || exit 1
          echo "‚úÖ Compatibility map present"

  fractal-benchmark:
    name: üéµ Fractal-1 Benchmark
    runs-on: ubuntu-latest
    needs: guardian
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install dependencies
        run: |
          cd apps/abyssos-portal
          npm install
      - name: Run Fractal-1 Benchmark
        run: |
          cd apps/abyssos-portal
          npx tsx src/fractall/fractall_benchmark.ts || echo "‚ö†Ô∏è Benchmark requires audio context (skipped in CI)"

  wallet-crypto-guard:
    name: üîê Wallet Cryptographic Guard
    runs-on: ubuntu-latest
    needs: guardian
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Verify Wallet Security Modules
        run: |
          test -f apps/abyssid-service/src/security/key_derivation_guard.ts || exit 1
          test -f apps/abyssid-service/src/security/signature_anomaly_detector.ts || exit 1
          test -f apps/abyssid-service/src/security/wallet_state_sentinel.ts || exit 1
          echo "‚úÖ All wallet security modules present"

  indexer-quantum-stability:
    name: ‚öõÔ∏è Indexer Quantum-Stability Guard
    runs-on: ubuntu-latest
    needs: guardian
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Verify Indexer Modules
        run: |
          test -f indexer/ingestor-rs/src/recovery_mode.rs || exit 1
          test -f indexer/ingestor-rs/src/block_drift_detector.rs || exit 1
          test -f indexer/ingestor-rs/src/canonical_chain_enforcer.rs || exit 1
          cargo check --manifest-path indexer/ingestor-rs/Cargo.toml
          echo "‚úÖ Indexer quantum-stability modules verified"

  dns-mutation-shield:
    name: üõ°Ô∏è DNS Mutation Shield
    runs-on: ubuntu-latest
    needs: guardian
    steps:
      - uses: actions/checkout@v4
      - name: Verify DNS Security Modules
        run: |
          test -f apps/dns-service/src/security/dns_state_guard.ts || exit 1
          test -f apps/dns-service/src/security/dns_update_verifier.ts || exit 1
          test -f apps/dns-service/src/security/dns_mutation_shield.ts || exit 1
          echo "‚úÖ All DNS security modules present"

  rust:
    name: Rust Check
    runs-on: ubuntu-latest
    needs: [guardian, runtime-integrity, schema-drift, sdk-compatibility]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo registry
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry
            ~/.cargo/git
            target
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}
      - name: Check Rust workspace
        run: cargo check --workspace
      - name: Verify runtime modules
        run: |
          grep -q "mod work_claim" chain/src/runtime/mod.rs || exit 1
          grep -q "WorkClaimModule" chain/src/runtime/mod.rs || exit 1

  portal-web:
    name: Portal Web (Next.js)
    runs-on: ubuntu-latest
    needs: guardian
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 9
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      - name: Lint
        run: pnpm --filter portal-web lint
      - name: Build
        run: pnpm --filter portal-web build

  sovereignty-seal:
    name: üîí Sovereignty Seal Verification
    runs-on: ubuntu-latest
    needs: [guardian, rust, portal-web, runtime-integrity, schema-drift, sdk-compatibility, fractal-benchmark, wallet-crypto-guard, indexer-quantum-stability, dns-mutation-shield]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Generate Sovereignty Seal
        shell: pwsh
        run: |
          pwsh -ExecutionPolicy Bypass -File scripts/generate-sovereignty-seal.ps1
      - name: Update Sovereignty Seal
        run: |
          npx tsx scripts/update-sovereignty-seal.ts
      - name: Verify Seal Integrity
        run: |
          test -f REPO_STATE_SEAL.json || exit 1
          node -e "const seal = require('./REPO_STATE_SEAL.json'); if (!seal.masterHash) throw new Error('Missing masterHash'); if (!seal.runtime) throw new Error('Missing runtime hashes'); console.log('‚úÖ Seal integrity verified')"
      - name: Upload Seal
        uses: actions/upload-artifact@v4
        with:
          name: repo-state-seal
          path: REPO_STATE_SEAL.json

