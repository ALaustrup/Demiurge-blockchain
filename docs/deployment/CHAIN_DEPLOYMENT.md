# Demiurge Chain Deployment Guide

Complete guide for deploying a Demiurge validator node on Ubuntu 24.04 LTS.

## Overview

The Demiurge chain deployment is designed to be deterministic, self-contained, and reproducible. A fresh Ubuntu 24.04 server can install and run a validator node using only:

1. `git clone`
2. `cargo build --release`
3. The deployment artifacts generated by the build pipeline

## Architecture

### Directory Structure

```
/opt/demiurge/
├── keys/
│   └── validator.key          # Ed25519 private key (32 bytes, 600 permissions)
├── configs/
│   ├── node.toml              # Node runtime configuration
│   └── genesis.toml           # Genesis state configuration
├── bin/
│   └── demiurge-chain         # Compiled chain binary
├── .demiurge/
│   └── data/                  # RocksDB database directory
└── [source code]              # Git repository
```

### Configuration Flow

1. **Validator Key Generation:**
   - Ed25519 key pair generated using `demiurge keygen`
   - Private key saved to `/opt/demiurge/keys/validator.key`
   - Public key derived to get validator address (64 hex chars)

2. **Genesis Configuration:**
   - Template at `chain/configs/genesis.toml` contains placeholder `validator_address_here`
   - Deployment script injects actual validator address
   - Final config saved to `/opt/demiurge/configs/genesis.toml`

3. **Node Configuration:**
   - Template at `chain/configs/node.toml` with production paths
   - RPC binding: `0.0.0.0:8545`
   - Database path: `/opt/demiurge/.demiurge/data`
   - Final config saved to `/opt/demiurge/configs/node.toml`

4. **Node Startup:**
   - Binary reads config from `/opt/demiurge/configs/node.toml`
   - Loads validator key from `/opt/demiurge/keys/validator.key`
   - If genesis still has placeholder, injects validator address at runtime
   - Initializes RocksDB database
   - Starts JSON-RPC server on `0.0.0.0:8545`

## Deployment Process

### Automated Deployment

```bash
# 1. Clone repository
sudo mkdir -p /opt/demiurge
sudo git clone <repo-url> /opt/demiurge
cd /opt/demiurge

# 2. Run deployment script
sudo chmod +x deploy/deploy-chain.sh
sudo ./deploy/deploy-chain.sh

# 3. Enable and start service
sudo systemctl enable demiurge-chain
sudo systemctl start demiurge-chain
```

### Manual Deployment

If you prefer manual control:

```bash
# 1. Create directories
sudo mkdir -p /opt/demiurge/{keys,configs,bin,.demiurge/data}
sudo chmod 700 /opt/demiurge/keys

# 2. Generate validator key
cd /opt/demiurge
cargo build --release --bin demiurge
./target/release/demiurge keygen --output /opt/demiurge/keys/validator.key

# 3. Copy and inject genesis config
VALIDATOR_ADDRESS=$(./target/release/demiurge keygen --output /opt/demiurge/keys/validator.key | grep "Validator address:" | awk '{print $3}')
sed "s/validator_address_here/${VALIDATOR_ADDRESS}/g" chain/configs/genesis.toml > /opt/demiurge/configs/genesis.toml

# 4. Copy node config
cp chain/configs/node.toml /opt/demiurge/configs/node.toml

# 5. Build chain
cargo build --release --bin demiurge-chain

# 6. Install binary
sudo cp target/release/demiurge-chain /opt/demiurge/bin/
sudo chmod +x /opt/demiurge/bin/demiurge-chain

# 7. Install systemd service
sudo cp deploy/systemd/demiurge-chain.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable demiurge-chain
sudo systemctl start demiurge-chain
```

## Configuration Reference

### Node Configuration (`node.toml`)

```toml
[chain]
chain_id = 77701
name = "Demiurge Mainnet"

[node]
rpc_host = "0.0.0.0"      # Bind to all interfaces
rpc_port = 8545           # JSON-RPC port
db_path = "/opt/demiurge/.demiurge/data"
p2p_listen = "0.0.0.0:30333"

[genesis]
genesis_config = "genesis.toml"
```

### Genesis Configuration (`genesis.toml`)

```toml
[chain]
chain_id = 77701
name = "Demiurge Mainnet"

[genesis]
genesis_archon_address = "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
genesis_archon_balance = "100000000000000"

[allocations]
faucet_address = "1111111111111111111111111111111111111111111111111111111111111111"
faucet_balance = "1000000000000000"
# ... other allocations

[[validators]]
address = "validator_address_here"  # Replaced during deployment
stake = "1000000000000"
```

## Systemd Service

The service file (`/etc/systemd/system/demiurge-chain.service`) configures:

- **User:** root (required for validator operations)
- **Working Directory:** `/opt/demiurge/`
- **Executable:** `/opt/demiurge/bin/demiurge-chain`
- **Restart Policy:** always (with 5 second delay)
- **Logging:** systemd journal
- **Security:** Restricted file system access, no new privileges

### Service Management

```bash
# Start service
sudo systemctl start demiurge-chain

# Stop service
sudo systemctl stop demiurge-chain

# Restart service
sudo systemctl restart demiurge-chain

# Check status
sudo systemctl status demiurge-chain

# View logs
sudo journalctl -u demiurge-chain -f

# View last 100 lines
sudo journalctl -u demiurge-chain -n 100
```

## Verification

### Check Node Status

```bash
# Service status
sudo systemctl status demiurge-chain

# Process status
ps aux | grep demiurge-chain

# Port listening
sudo netstat -tlnp | grep 8545
# or
sudo ss -tlnp | grep 8545
```

### Test JSON-RPC

```bash
# Get chain info
curl -X POST http://localhost:8545/rpc \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "cgt_getChainInfo",
    "params": {},
    "id": 1
  }'

# Get balance
curl -X POST http://localhost:8545/rpc \
  -H "Content-Type: application/json" \
  -d '{
    "jsonrpc": "2.0",
    "method": "cgt_getBalance",
    "params": {
      "address": "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"
    },
    "id": 1
  }'
```

### Verify Validator Key

```bash
# Extract validator address
/opt/demiurge/target/release/demiurge keygen --output /opt/demiurge/keys/validator.key

# Verify key file permissions
ls -la /opt/demiurge/keys/validator.key
# Should show: -rw------- (600 permissions)
```

## Troubleshooting

### Node Won't Start

1. **Check logs:**
   ```bash
   sudo journalctl -u demiurge-chain -n 50
   ```

2. **Verify configuration:**
   ```bash
   # Check config files exist
   ls -la /opt/demiurge/configs/
   
   # Verify validator key exists
   ls -la /opt/demiurge/keys/validator.key
   
   # Check database directory
   ls -ld /opt/demiurge/.demiurge/data
   ```

3. **Test binary manually:**
   ```bash
   cd /opt/demiurge
   ./bin/demiurge-chain
   ```

### RPC Not Accessible

1. **Check firewall:**
   ```bash
   sudo ufw status
   sudo ufw allow 8545/tcp
   ```

2. **Verify binding:**
   ```bash
   # Check config
   grep rpc_host /opt/demiurge/configs/node.toml
   
   # Test locally
   curl http://127.0.0.1:8545/rpc
   ```

3. **Check process:**
   ```bash
   sudo netstat -tlnp | grep 8545
   ```

### Genesis Issues

1. **Verify validator address injection:**
   ```bash
   grep -A 2 "validators" /opt/demiurge/configs/genesis.toml
   # Should show actual address, not "validator_address_here"
   ```

2. **Re-inject if needed:**
   ```bash
   VALIDATOR_ADDRESS=$(/opt/demiurge/target/release/demiurge keygen --output /opt/demiurge/keys/validator.key | grep "Validator address:" | awk '{print $3}')
   sed -i "s/validator_address_here/${VALIDATOR_ADDRESS}/g" /opt/demiurge/configs/genesis.toml
   ```

### Build Issues

1. **Ensure Rust is installed:**
   ```bash
   rustc --version
   cargo --version
   ```

2. **Clean and rebuild:**
   ```bash
   cd /opt/demiurge
   cargo clean
   cargo build --release --bin demiurge-chain
   ```

## Security Considerations

1. **Validator Key:**
   - Stored with 600 permissions (owner read/write only)
   - Never share or commit to version control
   - Backup securely if needed

2. **Network:**
   - RPC bound to `0.0.0.0:8545` (accessible from network)
   - Consider firewall rules to restrict access
   - Use reverse proxy (nginx) for production with TLS

3. **Service:**
   - Runs as root (required for validator operations)
   - File system access restricted via systemd
   - No new privileges allowed

## Production Recommendations

1. **Monitoring:**
   - Set up log aggregation
   - Monitor node health via RPC
   - Alert on service failures

2. **Backup:**
   - Regular backups of validator key
   - Database backups (RocksDB)
   - Configuration backups

3. **Updates:**
   - Test updates on staging environment
   - Use blue-green deployment if possible
   - Maintain rollback capability

4. **Network:**
   - Use nginx reverse proxy with TLS
   - Implement rate limiting
   - Consider VPN for admin access

## Next Steps

After successful deployment:

1. Verify node produces blocks (when block production is implemented)
2. Set up monitoring and alerting
3. Configure firewall rules
4. Set up automated backups
5. Document validator address for network registration

